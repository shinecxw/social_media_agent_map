<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OSMè·¯å¾„æ¨¡æ‹Ÿ</title>
  <!-- å…ˆåŠ è½½ç¬¬ä¸‰æ–¹åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1;
      max-width: 350px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status {
      margin-top: 10px;
      padding: 5px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .route-info {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 14px;
    }
    .instruction {
      margin: 5px 0;
      padding: 8px;
      background-color: #f8f8f8;
      border-radius: 4px;
      font-size: 13px;
    }
    .endpoints-list {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 14px;
    }
    .endpoint-item {
      margin: 5px 0;
      padding: 8px;
      background-color: #f8f8f8;
      border-radius: 4px;
      font-size: 13px;
      display: flex;
      align-items: center;
    }
    .endpoint-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }
    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 5px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .buttons {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    button {
      padding: 6px 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="control-panel">
  <div class="title">OSMè·¯å¾„æ¨¡æ‹Ÿ</div>
  <div class="status" id="status">å‡†å¤‡ä¸­...</div>
  <div class="buttons">
    <button id="loadStart">å®šä½èµ·ç‚¹</button>
    <button id="simulateRoute" disabled>æ¨¡æ‹Ÿè·¯å¾„</button>
  </div>
  <div class="route-info" id="routeInfo"></div>
  <div class="endpoints-list" id="endpointsList" style="display: none;"></div>
</div>

<script>
// ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–åœ°å›¾
document.addEventListener('DOMContentLoaded', () => {
  // å…ˆåŠ è½½input.js
  const script = document.createElement("script");
  script.src = "/js/input.js?t=" + Date.now();
  script.onload = () => {
    initMap();
  };
  document.head.appendChild(script);
});

function initMap() {
  mapboxgl.accessToken = 'pk.eyJ1Ijoic2hpbmV3ZWkiLCJhIjoiY2wyMzg5NmJ5MW54cDNpcDZ4d2FvdTM2OSJ9.U5838iGNGQwG-IwcaDQX7A';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [118.8, 32.06],
    zoom: 14
  });

  // DOM å…ƒç´ 
  const statusEl = document.getElementById('status');
  const routeInfoEl = document.getElementById('routeInfo');
  const endpointsListEl = document.getElementById('endpointsList');
  const loadStartBtn = document.getElementById('loadStart');
  const simulateRouteBtn = document.getElementById('simulateRoute');

  // å…¨å±€å˜é‡
  let routeInput = null;
  let startMarker = null;
  let endMarkers = []; // å­˜å‚¨æ‰€æœ‰ç»ˆç‚¹æ ‡è®°
  let routeSource = null;
  const PATH_COLORS = ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#9C27B0', '#FF6D00', '#795548']; // å®šä¹‰ä¸€ç»„è·¯å¾„é¢œè‰²
loadStartBtn.addEventListener('click', () => {
  statusEl.innerHTML = `<span class="loader"></span>æ­£åœ¨è·å–èµ·ç‚¹ä½ç½®: ${routeInput.start.name}...`;
  loadStartBtn.disabled = true;

  axios.post("/api/route/point/", { name: routeInput.start.name })
    .then(res => {
      const wgs = res.data.wgs84;
      statusEl.innerHTML = `å·²å®šä½èµ·ç‚¹: ${routeInput.start.name}<br>åæ ‡: [${wgs.lon.toFixed(5)}, ${wgs.lat.toFixed(5)}]<br>å‡†å¤‡æ¨¡æ‹Ÿè·¯å¾„...`;

      if (startMarker) startMarker.remove();

      startMarker = new mapboxgl.Marker({ color: '#4285F4' })
        .setLngLat([wgs.lon, wgs.lat])
        .addTo(map);

      map.flyTo({
        center: [wgs.lon, wgs.lat],
        zoom: 15,
        essential: true
      });

      simulateRouteBtn.disabled = false;
    })
    .catch(err => {
      console.error("ğŸš« è·å–åæ ‡å¤±è´¥ï¼š", err);
      statusEl.innerHTML = `è·å–åæ ‡å¤±è´¥: ${err.response?.data?.detail || err.message || 'æœªçŸ¥é”™è¯¯'}`;
      loadStartBtn.disabled = false;
    });
});

  // åŠ è½½åœ°å›¾
  map.on('load', () => {
    routeInput = window.routeInput;
    if (!routeInput) {
      statusEl.innerHTML = 'é”™è¯¯: æœªæ‰¾åˆ°è·¯å¾„è¾“å…¥æ•°æ®';
      return;
    }

    statusEl.innerHTML = `å·²åŠ è½½è·¯å¾„æ•°æ®<br>èµ·ç‚¹: ${routeInput.start.name}<br>ç»ˆç‚¹: ${routeInput.end.name}`;
    
    // æ·»åŠ è·¯å¾„å›¾å±‚
    map.addSource('route', {
      'type': 'geojson',
      'data': {
        'type': 'FeatureCollection',
        'features': []
      }
    });
    
    map.addLayer({
      'id': 'route-line',
      'type': 'line',
      'source': 'route',
      'layout': {
        'line-join': 'round',
        'line-cap': 'round'
      },
      'paint': {
        'line-color': ['get', 'color'],
        'line-width': 5,
        'line-opacity': 0.8
      }
    });
   
    map.addLayer({
  id: 'circle-fill',
  type: 'fill',
  source: 'route',
  filter: ['all', 
    ['==', ['get', 'type'], 'circle'],
    ['==', ['geometry-type'], 'Polygon']
  ],
  paint: {
    'fill-color': ['get', 'color'],
    'fill-opacity': ['get', 'opacity']
  }
});
routeSource = map.getSource('route');

   
  });

  // æ¸…é™¤æ‰€æœ‰ç»ˆç‚¹æ ‡è®°
  function clearEndMarkers() {
    endMarkers.forEach(marker => marker.remove());
    endMarkers = [];
    endpointsListEl.innerHTML = '';
    endpointsListEl.style.display = 'none';
  }

  // æ¨¡æ‹Ÿè·¯å¾„
  simulateRouteBtn.addEventListener('click', () => {
    if (!routeInput) {
      statusEl.innerHTML = 'é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°è·¯å¾„æ•°æ®';
      return;
    }

    statusEl.innerHTML = `<span class="loader"></span>æ­£åœ¨æ¨¡æ‹Ÿè·¯å¾„...`;
    simulateRouteBtn.disabled = true;
    
    // æ¸…é™¤æ—§çš„ç»ˆç‚¹æ ‡è®°
    clearEndMarkers();

    axios.post("/api/route/simulate/", routeInput)
      .then(res => {
        const routeData = res.data;

        console.log("è·¯å¾„æ•°æ®:", routeData);  // è°ƒè¯•ï¼Œç¡®ä¿è·¯å¾„æ•°æ®å®Œæ•´

        // æ›´æ–°è·¯å¾„å›¾å±‚
        routeSource.setData(routeData.route);
        // æ¸…é™¤æ—§çš„ç»ˆç‚¹æ ‡è®°
        clearEndMarkers();
        // è·å–ä¸»ç»ˆç‚¹é¢œè‰²å’Œåæ ‡
        const mainEndPoint = routeData.route.features.find(f => f.properties.type === 'endpoint');
        const mainEndColor = mainEndPoint ? mainEndPoint.properties.color : '#DB4437'; // ä½¿ç”¨GeoJSONä¸­çš„é¢œè‰²æˆ–é»˜è®¤çº¢è‰²
        const mainEndCoords = routeData.end?.coordinates || mainEndPoint?.geometry?.coordinates || [0, 0];
        if (routeData.node_count > 1) {  // æˆ–æ£€æŸ¥ routeData.route.features ä¸­æ˜¯å¦æœ‰ type = 'endpoint' çš„ç‰¹å¾
          const mainEndCoords = routeData.end.coordinates;
        
          // æ·»åŠ ä¸»ç»ˆç‚¹æ ‡è®°
          const mainEndMarker = new mapboxgl.Marker({ color: mainEndColor })
            .setLngLat([mainEndCoords.lon, mainEndCoords.lat])
            .addTo(map);
          endMarkers.push(mainEndMarker);
      }// æ·»åŠ ä¸­é—´ç‚¹æ ‡è®°ï¼ˆç»¿è‰²ç‚¹ï¼‰
          const intermediatePointFeatures = routeData.route.features.filter(f => 
            f.geometry.type === 'Point' && f.properties.type === 'intermediate_point'
          );

          console.log("æ‰¾åˆ°ä¸­é—´ç‚¹ç‰¹å¾:", intermediatePointFeatures); // è°ƒè¯•ç”¨

          intermediatePointFeatures.forEach(feature => {
            const coords = feature.geometry.coordinates;
            const color = feature.properties.color; // åº”è¯¥æ˜¯ç»¿è‰² (#00FF00)
            
            // åˆ›å»ºä¸­é—´ç‚¹æ ‡è®°
            const intermediateMarker = new mapboxgl.Marker({ color: color })
              .setLngLat(coords)
              .addTo(map);
            
            endMarkers.push(intermediateMarker);
            
            // å¯é€‰ï¼šåœ¨æ§åˆ¶å°è¾“å‡ºä»¥ä¾¿è°ƒè¯•
            console.log(`æ·»åŠ ä¸­é—´ç‚¹æ ‡è®°: åæ ‡=[${coords}], é¢œè‰²=${color}`);
          });

        // æ·»åŠ å¯èƒ½çš„ç»ˆç‚¹æ ‡è®°å’Œä¿¡æ¯
        if (routeData.possible_end_points && routeData.possible_end_points.length > 0) {
          endpointsListEl.style.display = 'block';
          endpointsListEl.innerHTML = '<div class="title">å¯èƒ½çš„ç»ˆç‚¹åˆ—è¡¨</div>';
          
          // æ·»åŠ ä¸»è·¯å¾„ç»ˆç‚¹
          const mainEndpointItem = document.createElement('div');
          mainEndpointItem.className = 'endpoint-item';
          const mainColorSpan = document.createElement('span');
          mainColorSpan.className = 'endpoint-color';
          mainColorSpan.style.backgroundColor = mainEndColor;
          mainEndpointItem.appendChild(mainColorSpan);
          mainEndpointItem.appendChild(document.createTextNode(
            `ä¸»è·¯å¾„ç»ˆç‚¹: [${mainEndCoords.lon.toFixed(5)}, ${mainEndCoords.lat.toFixed(5)}]`
          ));
          endpointsListEl.appendChild(mainEndpointItem);
           // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½ç»ˆç‚¹çš„GeoJSONç‰¹æ€§
          const endPointFeatures = routeData.route.features.filter(f => 
          f.properties.type === 'possible_endpoint');
        
          
          // æ·»åŠ æ‰€æœ‰å¯èƒ½çš„ç»ˆç‚¹
          routeData.possible_end_points.forEach((endpoint, index) => {
            // å°è¯•ä»GeoJSONä¸­æ‰¾åˆ°å¯¹åº”çš„ç‰¹æ€§ä»¥è·å–é¢œè‰²
            const feature = endPointFeatures.find(f => 
              f.geometry.coordinates[0] === endpoint.coordinates.lon && 
              f.geometry.coordinates[1] === endpoint.coordinates.lat);
            
            const color = feature ? feature.properties.color : PATH_COLORS[(index + 1) % PATH_COLORS.length];
            
            // åˆ›å»ºæ ‡è®°
            const marker = new mapboxgl.Marker({ color: color })
              .setLngLat([endpoint.coordinates.lon, endpoint.coordinates.lat])
              .addTo(map);
            endMarkers.push(marker);
              
              // åˆ›å»ºç»ˆç‚¹ä¿¡æ¯åˆ—è¡¨é¡¹
              const endpointItem = document.createElement('div');
              endpointItem.className = 'endpoint-item';
              
              const colorSpan = document.createElement('span');
              colorSpan.className = 'endpoint-color';
              colorSpan.style.backgroundColor = color;
              
              endpointItem.appendChild(colorSpan);
              endpointItem.appendChild(document.createTextNode(
                `ç»ˆç‚¹ ${index + 1}: [${endpoint.coordinates.lon.toFixed(5)}, ${endpoint.coordinates.lat.toFixed(5)}]` +
                ` - è·¯æ®µ ${endpoint.segment_id}` +
                ` - è·ç¦» ${endpoint.distance.toFixed(2)}ç±³` +
                (endpoint.direction ? ` - æ–¹å‘ ${endpoint.direction}` : '')
              ));
              
              endpointsListEl.appendChild(endpointItem);
            });
        }

        // è°ƒæ•´åœ°å›¾è§†è§’ä»¥æ˜¾ç¤ºæ•´ä¸ªè·¯å¾„å’Œæ‰€æœ‰ç»ˆç‚¹
        const bounds = new mapboxgl.LngLatBounds();
        
        // æ·»åŠ ä¸»è·¯å¾„æ‰€æœ‰ç‚¹åˆ°è¾¹ç•Œ
        routeData.route.features.forEach(feature => {
          if (feature.geometry.type === 'LineString') {
            feature.geometry.coordinates.forEach(coord => {
              bounds.extend(coord);
            });
          } else if (feature.geometry.type === 'Point') {
            bounds.extend(feature.geometry.coordinates);
          }
        });
        
        // æ·»åŠ æ‰€æœ‰å¯èƒ½ç»ˆç‚¹åˆ°è¾¹ç•Œ
        if (routeData.possible_end_points) {
          routeData.possible_end_points.forEach(endpoint => {
            bounds.extend([endpoint.coordinates.lon, endpoint.coordinates.lat]);
          });
        }

        map.fitBounds(bounds, {
          padding: 50,
          duration: 1000
        });

        // æ›´æ–°çŠ¶æ€
        statusEl.innerHTML = `è·¯å¾„è®¡ç®—å®Œæˆ!<br>æ€»è·ç¦»: ${routeData.distance.toFixed(2)}ç±³<br>èŠ‚ç‚¹æ•°: ${routeData.node_count}`;
        if (routeData.possible_end_points && routeData.possible_end_points.length > 0) {
          statusEl.innerHTML += `<br>å¯èƒ½çš„ç»ˆç‚¹æ•°é‡: ${routeData.possible_end_points.length}`;
        }
        
        simulateRouteBtn.disabled = false;
      })
      .catch(err => {
        console.error("ğŸš« è·¯å¾„æ¨¡æ‹Ÿå¤±è´¥ï¼š", err);
        statusEl.innerHTML = `è·¯å¾„æ¨¡æ‹Ÿå¤±è´¥: ${err.response?.data?.detail || err.message || 'æœªçŸ¥é”™è¯¯'}`;
        simulateRouteBtn.disabled = false;
      });
  });
}
</script>
</body>
</html>